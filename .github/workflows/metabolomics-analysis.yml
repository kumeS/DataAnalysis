name: Claude · Metabolomics Analysis

on:
  push:
    paths:
      - 'data/**.csv'
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]

jobs:
  analysis:
    runs-on: ubuntu-latest
    if: >-
      (
        github.event_name == 'push' ||
        (
          github.event_name == 'issues' && 
          contains(github.event.issue.title, '統合') ||
          contains(github.event.issue.title, '単一') ||
          contains(github.event.issue.title, 'Metabolomics Analysis')
        ) ||
        (
          github.event_name == 'issue_comment' && 
          contains(github.event.comment.body, '@claude') &&
          (
            contains(github.event.issue.title, '統合') ||
            contains(github.event.issue.title, '単一') ||
            contains(github.event.issue.title, 'Metabolomics Analysis')
          )
        )
      )
    permissions:
      contents: write          # Claude がコミットする場合に備える
      issues: write
      pull-requests: write
      id-token: write          # OIDC token のため

    steps:
    # 1) ソース取得 --------------------------------------------------------
    - uses: actions/checkout@v4

    # 2) R ランタイムを用意 ----------------------------------------------
    - uses: r-lib/actions/setup-r@v2             # 公式アクション:contentReference[oaicite:5]{index=5}

    # 3) R パッケージ導入 (最小限) -------------------------------------------
    - name: Install essential R packages
      run: |
        Rscript -e 'install.packages(c("readr","dplyr","ggplot2","pheatmap","corrplot"), repos="https://cran.r-project.org")'

    # 4) Claude Code を呼び出し ------------------------------------------
    - name: Claude ➜ run full R analysis
      id: claude
      uses: anthropics/claude-code-action@beta
      with:
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

        ##################  Claude への指示  ##################
        direct_prompt: |
          **Goal**: Perform metabolomics analysis in R on the CSV at `fasting.csv`.  
          **Steps**  
          1. Create an R script that reads the CSV using `readr::read_csv()`
          2. Perform basic exploratory analysis: dimensions, summary statistics
          3. Compare normal vs 12h_fasting groups using t-tests
          4. Create visualizations: PCA plot, heatmap of top differential metabolites
          5. Save results and plots as files
          6. Create a simple markdown report summarizing findings
          
          Use only the installed R packages: readr, dplyr, ggplot2, pheatmap, corrplot.
          Write all code as R scripts and execute them using Bash commands like `Rscript script.R`.

        ##################  Claude が使えるツール ############
        allowed_tools: |
          Bash, Edit, Write, Read


        ##################  実行環境変数  ###################
        claude_env: |
          DATA_PATH=fasting.csv

    # 5) 生成レポートをアーティファクト保存 ----------------
    - name: Upload analysis results
      uses: actions/upload-artifact@v4
      with:
        name: metabolomics-analysis-results
        path: |
          *.png
          *.pdf
          *.md
          *.R
        if-no-files-found: warn
