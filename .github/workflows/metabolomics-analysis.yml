name: Claude Â· Metabolomics Analysis

on:
  workflow_dispatch:
    inputs:
      data_path:
        description: 'CSV file path'
        required: true
        default: 'fasting.csv'

jobs:
  analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: write          # ãƒªãƒã‚¸ãƒˆãƒªã¸ã®çµæœä¿å­˜ã®ãŸã‚
      issues: write
      pull-requests: write
      id-token: write          # OIDC token ã®ãŸã‚
      actions: read            # Claude Code Action ã®ãŸã‚

    steps:
    # 1) ã‚½ãƒ¼ã‚¹å–å¾— --------------------------------------------------------
    - uses: actions/checkout@v4

    # 2) R ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’ç”¨æ„ ----------------------------------------------
    - uses: r-lib/actions/setup-r@v2             # å…¬å¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:contentReference[oaicite:5]{index=5}

    # 3) R ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å°å…¥ (æœ€å°é™) -------------------------------------------
    - name: Install essential R packages
      run: |
        Rscript -e 'install.packages(c("readr","dplyr","ggplot2","pheatmap","corrplot"), repos="https://cran.r-project.org")'

    # 4) Rè§£æã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç›´æ¥å®Ÿè¡Œ ------------------------------------------
    - name: Run metabolomics analysis
      run: |
        # Create R analysis script
        cat > metabolomics_analysis.R << 'EOF'
        # Load required libraries
        library(readr)
        library(dplyr)
        library(ggplot2)
        library(pheatmap)
        library(corrplot)
        
        # Read data (CSV with semicolon separator)
        data <- read_csv2("${{ github.event.inputs.data_path || 'fasting.csv' }}")
        
        # Basic exploration
        cat("Data dimensions:", dim(data), "\n")
        print(summary(data))
        
        # Save basic info
        write.csv(summary(data), "summary_stats.csv")
        
        # PCA analysis
        numeric_data <- data %>% select_if(is.numeric)
        
        # Check if we have enough numeric data
        if (ncol(numeric_data) > 1 && nrow(numeric_data) > 1) {
          pca_result <- prcomp(numeric_data, scale. = TRUE)
          
          # PCA plot
          png("pca_plot.png", width = 800, height = 600)
          biplot(pca_result, main = "PCA Analysis")
          dev.off()
          
          # Correlation matrix
          cor_matrix <- cor(numeric_data, use = "complete.obs")
          png("correlation_matrix.png", width = 800, height = 600)
          corrplot(cor_matrix, method = "circle")
          dev.off()
          
          # Heatmap (use correlation matrix for visualization)
          png("heatmap.png", width = 800, height = 600)
          pheatmap(cor_matrix, main = "Metabolite Correlation Heatmap")
          dev.off()
        } else {
          cat("Warning: Not enough numeric data for analysis\n")
          # Create empty plots as placeholders
          png("pca_plot.png", width = 800, height = 600)
          plot(1, type="n", main="PCA Analysis - Not enough data")
          dev.off()
          
          png("correlation_matrix.png", width = 800, height = 600)
          plot(1, type="n", main="Correlation Matrix - Not enough data")
          dev.off()
          
          png("heatmap.png", width = 800, height = 600)
          plot(1, type="n", main="Heatmap - Not enough data")
          dev.off()
        }
        
        # Create detailed report
        cat("# Metabolomics Analysis Report\n\n", file = "analysis_report.md")
        cat("**Analysis Date:**", Sys.Date(), "\n", file = "analysis_report.md", append = TRUE)
        cat("**Data Source:** ${{ github.event.inputs.data_path || 'fasting.csv' }}\n\n", file = "analysis_report.md", append = TRUE)
        
        cat("## Data Overview\n", file = "analysis_report.md", append = TRUE)
        cat("- **Dimensions:**", dim(data)[1], "rows x", dim(data)[2], "columns\n", file = "analysis_report.md", append = TRUE)
        cat("- **Numeric columns:**", ncol(numeric_data), "\n", file = "analysis_report.md", append = TRUE)
        cat("- **Data type:** Metabolomics concentration data\n\n", file = "analysis_report.md", append = TRUE)
        
        # Data quality assessment
        if (ncol(numeric_data) > 1) {
          missing_data <- sum(is.na(numeric_data))
          total_values <- nrow(numeric_data) * ncol(numeric_data)
          missing_percent <- round(missing_data / total_values * 100, 2)
          
          cat("## Data Quality Assessment\n", file = "analysis_report.md", append = TRUE)
          cat("- **Missing values:**", missing_data, "out of", total_values, "(", missing_percent, "%)\n", file = "analysis_report.md", append = TRUE)
          cat("- **Data completeness:**", round(100 - missing_percent, 2), "%\n", file = "analysis_report.md", append = TRUE)
          
          # Statistical summary
          cat("\n## Statistical Summary\n", file = "analysis_report.md", append = TRUE)
          cat("- **Mean concentration range:**", round(min(apply(numeric_data, 2, mean, na.rm=TRUE)), 6), 
              "to", round(max(apply(numeric_data, 2, mean, na.rm=TRUE)), 6), "\n", file = "analysis_report.md", append = TRUE)
          cat("- **Standard deviation range:**", round(min(apply(numeric_data, 2, sd, na.rm=TRUE)), 6), 
              "to", round(max(apply(numeric_data, 2, sd, na.rm=TRUE)), 6), "\n", file = "analysis_report.md", append = TRUE)
        }
        
        cat("\n## Analysis Results\n", file = "analysis_report.md", append = TRUE)
        if (ncol(numeric_data) > 1 && nrow(numeric_data) > 1) {
          cat("- âœ… PCA analysis completed successfully\n", file = "analysis_report.md", append = TRUE)
          cat("- âœ… Correlation matrix generated\n", file = "analysis_report.md", append = TRUE)
          cat("- âœ… Heatmap visualization created\n", file = "analysis_report.md", append = TRUE)
          
          if (exists("pca_result")) {
            # PCA insights
            variance_explained <- round(summary(pca_result)$importance[2,1:2] * 100, 2)
            cat("- **PCA PC1 variance explained:**", variance_explained[1], "%\n", file = "analysis_report.md", append = TRUE)
            cat("- **PCA PC2 variance explained:**", variance_explained[2], "%\n", file = "analysis_report.md", append = TRUE)
            cat("- **Total variance explained (PC1+PC2):**", sum(variance_explained), "%\n", file = "analysis_report.md", append = TRUE)
          }
          
          if (exists("cor_matrix")) {
            # Correlation insights
            high_corr <- sum(abs(cor_matrix) > 0.7 & cor_matrix != 1, na.rm=TRUE) / 2
            cat("- **High correlations (>0.7):**", high_corr, "metabolite pairs\n", file = "analysis_report.md", append = TRUE)
          }
        } else {
          cat("- âš ï¸ Insufficient data for statistical analysis\n", file = "analysis_report.md", append = TRUE)
          cat("- âš ï¸ Placeholder plots generated\n", file = "analysis_report.md", append = TRUE)
        }
        
        cat("\n## Generated Files\n", file = "analysis_report.md", append = TRUE)
        cat("- `pca_plot.png` - Principal Component Analysis biplot\n", file = "analysis_report.md", append = TRUE)
        cat("- `correlation_matrix.png` - Metabolite correlation heatmap\n", file = "analysis_report.md", append = TRUE)
        cat("- `heatmap.png` - Metabolite concentration heatmap\n", file = "analysis_report.md", append = TRUE)
        cat("- `summary_stats.csv` - Statistical summary of the data\n", file = "analysis_report.md", append = TRUE)
        cat("- `analysis_report.md` - This comprehensive report\n", file = "analysis_report.md", append = TRUE)
        
        cat("\n## Interpretation Notes\n", file = "analysis_report.md", append = TRUE)
        cat("This analysis provides insights into metabolite concentration patterns in fasting samples. ", file = "analysis_report.md", append = TRUE)
        cat("The PCA analysis reveals the main sources of variation in the metabolite profile, ", file = "analysis_report.md", append = TRUE)
        cat("while correlation analysis identifies metabolites that show similar patterns. ", file = "analysis_report.md", append = TRUE)
        cat("These results can inform understanding of metabolic states and potential biomarkers.\n", file = "analysis_report.md", append = TRUE)
        EOF
        
        # Execute R script
        Rscript metabolomics_analysis.R

    # 5) Claude Code Action ã‚’ä½¿ã£ãŸçœŸã®AIè§£é‡ˆ --------------------------
    - name: Prepare analysis files for Claude interpretation
      run: |
        # Create a comprehensive prompt file for Claude
        cat > claude_analysis_prompt.md << 'EOF'
        # Metabolomics Analysis Interpretation Request

        Please analyze the metabolomics analysis results and provide comprehensive scientific interpretation.

        ## Context
        - **Data source**: ${{ github.event.inputs.data_path || 'fasting.csv' }}
        - **Analysis type**: Metabolomics data analysis with PCA, correlation matrix, and visualization
        - **Sample type**: Fasting metabolomics data

        ## Analysis Files Generated
        Please examine these analysis outputs:
        - `analysis_report.md` - Comprehensive analysis report
        - `summary_stats.csv` - Statistical summary of the data
        - `pca_plot.png` - Principal Component Analysis biplot
        - `correlation_matrix.png` - Metabolite correlation heatmap
        - `heatmap.png` - Metabolite concentration heatmap

        ## Interpretation Request

        Please provide a comprehensive scientific interpretation covering:

        ### 1. Executive Summary
        - Key findings from the metabolomics analysis
        - Overview of metabolic patterns identified

        ### 2. Statistical Interpretation
        - PCA results and variance explanation
        - Correlation patterns and significance
        - Data quality assessment

        ### 3. Biological Significance
        - Metabolic pathway implications
        - Fasting state metabolic profile insights
        - Potential biomarkers identified

        ### 4. Clinical Relevance
        - Health implications of findings
        - Diagnostic potential
        - Therapeutic insights

        ### 5. Technical Assessment
        - Data processing quality
        - Statistical validity
        - Methodological strengths/limitations

        ### 6. Recommendations
        - Immediate next steps
        - Future research directions
        - Additional analyses suggested

        Please base your interpretation on the actual data and results provided in the analysis files.
        EOF

    - name: Generate Claude AI Interpretation
      uses: anthropics/claude-code-action@beta
      with:
        claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        direct_prompt: |
          Please analyze the metabolomics analysis results and provide comprehensive scientific interpretation.
          
          I have generated several analysis files:
          - analysis_report.md (comprehensive analysis report)
          - summary_stats.csv (statistical summary)
          - pca_plot.png (PCA analysis visualization)
          - correlation_matrix.png (correlation heatmap)
          - heatmap.png (metabolite concentration heatmap)
          
          Please read these files and provide a detailed scientific interpretation covering:
          
          1. **Executive Summary**: Key findings from the metabolomics analysis
          2. **Statistical Interpretation**: PCA results, correlation patterns, data quality
          3. **Biological Significance**: Metabolic pathway implications, fasting state insights, biomarkers
          4. **Clinical Relevance**: Health implications, diagnostic potential, therapeutic insights
          5. **Technical Assessment**: Data processing quality, statistical validity, methodological strengths
          6. **Recommendations**: Next steps, future research directions, additional analyses
          
          Focus on the actual data patterns in the generated files. Create a new file called 
          'claude_interpretation.md' with your comprehensive analysis.

    # 6) çµæœã‚’ãƒªãƒã‚¸ãƒˆãƒªã«ä¿å­˜ ----------------------------------------
    - name: Create results directory
      run: |
        mkdir -p results/metabolomics-analysis/$(date +%Y%m%d_%H%M%S)
        RESULT_DIR="results/metabolomics-analysis/$(date +%Y%m%d_%H%M%S)"
        
        # Copy all generated files
        cp *.png "$RESULT_DIR/" 2>/dev/null || echo "No PNG files to copy"
        cp *.pdf "$RESULT_DIR/" 2>/dev/null || echo "No PDF files to copy" 
        cp *.md "$RESULT_DIR/" 2>/dev/null || echo "No MD files to copy"
        cp *.csv "$RESULT_DIR/" 2>/dev/null || echo "No CSV files to copy"
        cp *.R "$RESULT_DIR/" 2>/dev/null || echo "No R files to copy"
        
        # Create summary
        echo "# Metabolomics Analysis Results" > "$RESULT_DIR/README.md"
        echo "" >> "$RESULT_DIR/README.md"
        echo "**Analysis Date:** $(date)" >> "$RESULT_DIR/README.md"
        echo "**Data Source:** ${{ github.event.inputs.data_path || 'fasting.csv' }}" >> "$RESULT_DIR/README.md"
        echo "**Workflow:** Claude Â· Metabolomics Analysis" >> "$RESULT_DIR/README.md"
        echo "" >> "$RESULT_DIR/README.md"
        echo "## Generated Files" >> "$RESULT_DIR/README.md"
        ls -la "$RESULT_DIR/" | grep -v "^total" | grep -v "^d" | awk '{print "- " $9}' >> "$RESULT_DIR/README.md"
        
        echo "RESULT_DIR=$RESULT_DIR" >> $GITHUB_ENV

    - name: Commit results to repository
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add results/
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Add metabolomics analysis results from $(date)

          Generated by Claude Â· Metabolomics Analysis workflow
          Data source: ${{ github.event.inputs.data_path || 'fasting.csv' }}
          
          ğŸ¤– Generated with Claude Code integration
          
          Co-Authored-By: Claude <noreply@anthropic.com>"
          
          git push
        fi

    # 7) ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚‚ä¿å­˜ (ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—) -------------------------
    - name: Upload analysis results as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: metabolomics-analysis-results
        path: |
          results/
          *.png
          *.pdf
          *.md
          *.R
          *.csv
        if-no-files-found: warn
