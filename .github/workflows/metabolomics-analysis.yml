name: Claude · Metabolomics Analysis

on:
  workflow_dispatch:
    inputs:
      data_path:
        description: 'CSV file path'
        required: true
        default: 'fasting.csv'

jobs:
  analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: write          # Claude がコミットする場合に備える
      issues: write
      pull-requests: write
      id-token: write          # OIDC token のため

    steps:
    # 1) ソース取得 --------------------------------------------------------
    - uses: actions/checkout@v4

    # 2) R ランタイムを用意 ----------------------------------------------
    - uses: r-lib/actions/setup-r@v2             # 公式アクション:contentReference[oaicite:5]{index=5}

    # 3) R パッケージ導入 (最小限) -------------------------------------------
    - name: Install essential R packages
      run: |
        Rscript -e 'install.packages(c("readr","dplyr","ggplot2","pheatmap","corrplot"), repos="https://cran.r-project.org")'

    # 4) R解析スクリプトを直接実行 ------------------------------------------
    - name: Run metabolomics analysis
      run: |
        # Create R analysis script
        cat > metabolomics_analysis.R << 'EOF'
        # Load required libraries
        library(readr)
        library(dplyr)
        library(ggplot2)
        library(pheatmap)
        library(corrplot)
        
        # Read data
        data <- read_csv("${{ github.event.inputs.data_path || 'fasting.csv' }}")
        
        # Basic exploration
        cat("Data dimensions:", dim(data), "\n")
        print(summary(data))
        
        # Save basic info
        write.csv(summary(data), "summary_stats.csv")
        
        # PCA analysis
        numeric_data <- data %>% select_if(is.numeric)
        pca_result <- prcomp(numeric_data, scale. = TRUE)
        
        # PCA plot
        png("pca_plot.png", width = 800, height = 600)
        biplot(pca_result, main = "PCA Analysis")
        dev.off()
        
        # Correlation matrix
        cor_matrix <- cor(numeric_data, use = "complete.obs")
        png("correlation_matrix.png", width = 800, height = 600)
        corrplot(cor_matrix, method = "circle")
        dev.off()
        
        # Heatmap
        png("heatmap.png", width = 800, height = 600)
        pheatmap(cor_matrix, main = "Metabolite Correlation Heatmap")
        dev.off()
        
        # Create report
        cat("# Metabolomics Analysis Report\n\n", file = "analysis_report.md")
        cat("## Data Overview\n", file = "analysis_report.md", append = TRUE)
        cat("- Dimensions:", dim(data)[1], "rows x", dim(data)[2], "columns\n\n", file = "analysis_report.md", append = TRUE)
        cat("## Analysis Results\n", file = "analysis_report.md", append = TRUE)
        cat("- PCA analysis completed\n", file = "analysis_report.md", append = TRUE)
        cat("- Correlation matrix generated\n", file = "analysis_report.md", append = TRUE)
        cat("- Heatmap visualization created\n", file = "analysis_report.md", append = TRUE)
        EOF
        
        # Execute R script
        Rscript metabolomics_analysis.R

    # 5) 生成レポートをアーティファクト保存 ----------------
    - name: Upload analysis results
      uses: actions/upload-artifact@v4
      with:
        name: metabolomics-analysis-results
        path: |
          *.png
          *.pdf
          *.md
          *.R
        if-no-files-found: warn
