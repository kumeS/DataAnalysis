# .github/workflows/claude-r-parallel.yml
name: Claude · Parallel Metabolomics Analysis

on:
  workflow_dispatch:
    inputs:
      csv:
        description: "CSV path (fasting.csv)"
        required: true
        default: "fasting.csv"
  push:
    paths: ["data/**.csv"]

concurrency:             # 同じブランチで1つだけ動かす
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ──────────────────────────────────────────────
  analyse:
    # ❶ ここが並列化ポイント
    strategy:
      matrix:
        task: [eda, modeling, viz]      # 3 つの軸
    runs-on: ubuntu-latest
    name: run-${{ matrix.task }}
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write          # OIDC token のため

    steps:
      - uses: actions/checkout@v4

      # R & mcptools 用意
      - uses: r-lib/actions/setup-r@v2
      - name: Install essential R packages
        run: |
          Rscript -e 'install.packages(c("readr","dplyr","ggplot2","pheatmap","corrplot"), repos="https://cran.r-project.org")'

      # Claude Code 呼び出し ── task で prompt 切替
      - name: Claude ${{ matrix.task }}
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          allowed_tools: |
            Bash, Edit, Write, Read

          # task 固有プロンプト
          direct_prompt: |
            You are the R analyst responsible for the **${{ matrix.task }}** stage on metabolomics data `${{ github.event.inputs.csv || 'fasting.csv' }}`.
            
            Create folder `artifacts/${{ matrix.task }}/` and produce:
            - eda: basic data exploration, summary statistics, correlation matrix, PCA plot
            - modeling: t-tests comparing normal vs 12h_fasting groups, save significant results
            - viz: heatmap of top differential metabolites, boxplots of key metabolites
            
            Use only: readr, dplyr, ggplot2, pheatmap, corrplot packages.
            Write R scripts and execute with `Rscript script.R`.
            Save a short `note.md` describing your findings.

          claude_env: |
            DATA=${{ github.event.inputs.csv || 'fasting.csv' }}
            TASK=${{ matrix.task }}

      # 成果物をアップロード（ジョブごと）
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.task }}-outputs
          path: artifacts/${{ matrix.task }}/
  # ──────────────────────────────────────────────
  merge-report:
    needs: analyse            # ❷ すべて終わってから実行
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: _merge

      # 統合レポート：Markdown を結合
      - name: Build final report
        run: |
          echo "# Metabolomics Analysis Report" > FINAL_REPORT.md
          echo "" >> FINAL_REPORT.md
          for task in eda modeling viz; do
            if [ -f "_merge/${task}-outputs/note.md" ]; then
              echo "## ${task^^} Results" >> FINAL_REPORT.md
              cat "_merge/${task}-outputs/note.md" >> FINAL_REPORT.md
              echo "" >> FINAL_REPORT.md
            fi
          done

      - uses: actions/upload-artifact@v4
        with:
          name: final-report
          path: FINAL_REPORT.md
