# .github/workflows/claude-r-parallel.yml
name: Claude · Parallel Metabolomics Analysis

on:
  workflow_dispatch:
    inputs:
      csv:
        description: "CSV path (fasting.csv)"
        required: true
        default: "fasting.csv"
  push:
    paths: ["data/**.csv"]

concurrency:             # 同じブランチで1つだけ動かす
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ──────────────────────────────────────────────
  analyse:
    # ❶ ここが並列化ポイント
    strategy:
      matrix:
        task: [eda, modeling, viz]      # 3 つの軸
    runs-on: ubuntu-latest
    name: run-${{ matrix.task }}

    steps:
      - uses: actions/checkout@v4

      # R & mcptools 用意
      - uses: r-lib/actions/setup-r@v2
      - name: Install deps
        run: |
          Rscript -e 'install.packages(c("pak","rmarkdown","tidyverse","skimr","ggplot2","pheatmap","VennDiagram","corrplot"))'
          Rscript -e 'pak::pkg_install("posit-dev/mcptools")'

      # Claude Code 呼び出し ── task で prompt 切替
      - name: Claude ${{ matrix.task }}
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          mcp_config: |
            { "mcpServers": { "r": {
                "type": "stdio",
                "command": "Rscript",
                "args": ["-e","mcptools::mcp_server()"] } } }
          allowed_tools: |
            mcp__r__run_code, Edit, FileCreate

          # task 固有プロンプト
          prompt: |
            You are the R analyst responsible for the **${{ matrix.task }}**
            stage on metabolomics data `${{ github.event.inputs.csv || 'fasting.csv' }}`.
            Produce scripts and outputs in the folder `artifacts/${{ matrix.task }}`:
            - eda: skimr summary for normal vs 12h_fasting groups, correlation matrix, PCA plot
            - modeling: t-tests for differential metabolites, volcano plot, save significant results as RDS
            - viz: heatmap of top differential metabolites, boxplots of key metabolites
            Save a short Markdown note `note.md` describing your findings about fasting-induced metabolic changes.

          claude_env: |
            DATA=${{ github.event.inputs.csv || 'fasting.csv' }}
            TASK=${{ matrix.task }}

      # 成果物をアップロード（ジョブごと）
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.task }}-outputs
          path: artifacts/${{ matrix.task }}/
  # ──────────────────────────────────────────────
  merge-report:
    needs: analyse            # ❷ すべて終わってから実行
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: _merge

      # 統合レポート：Markdown を結合 → PDF
      - name: Build final PDF
        run: |
          cat _merge/*/note.md > FINAL_REPORT.md
          pandoc FINAL_REPORT.md -o FINAL_REPORT.pdf

      - uses: actions/upload-artifact@v4
        with:
          name: final-report
          path: FINAL_REPORT.pdf
